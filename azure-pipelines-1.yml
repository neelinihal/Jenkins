trigger:
- main

resources:
- repo: self

variables:
- group: GCP-Deploy   # Links your secret variables: DOCKER_USERNAME, DOCKER_PASSWORD, GCP_SA_KEY
- name: tag
  value: '$(Build.BuildId)'
- name: imageName
  value: 'docker.io/neelinihal/jenkins-app:$(tag)'

stages:
- stage: BuildAndDeploy
  displayName: Build and Deploy to Docker Hub
  jobs:
  - job: Build
    displayName: Build and Push
    pool:
      name: MyVM
    steps:

    # Login to Docker Hub using personal credentials
    - script: |
        echo "$(DOCKER_PASSWORD)" | docker login -u "$(DOCKER_USERNAME)" --password-stdin
      displayName: 'Login to Docker Hub'
      env:
        DOCKER_USERNAME: $(DOCKER_USERNAME)
        DOCKER_PASSWORD: $(DOCKER_PASSWORD)

    # Build Docker image locally
    - script: |
        docker build -t $(imageName) .
      displayName: 'Build Docker Image'

    # Push Docker image to Docker Hub
    - script: |
        docker push $(imageName)
      displayName: 'Push Docker Image'
